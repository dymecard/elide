steps:
  - command: "make build CI=yes"
    label: ":bazel: Build: Framework"
    key: framework-build

  - command: "make build test report-coverage report-tests CI=yes"
    label: ":coverage: Testsuite"
    depends_on: framework-build
    artifact_paths:
      - "reports/coverage/index.html"
      - "reports/tests.xml.html"

  - command: "make build CI=yes TARGETS='//samples/rest_mvc/java:MicronautMVCSample-native-bin' && make build CI=yes TARGETS='//samples/soy_ssr/src:MicronautSSRSample-native-bin'"
    label: ":java: Build: Native Binaries"
    depends_on: framework-build

  - wait

  - command: "docker pull us.gcr.io/elide-tools/base/alpine"
    label: ":docker: Pull Bases"

  - command: "make build samples CI=yes"
    label: ":gcloud: Publish: Images"

  - command: "echo 'registry=https://npm.pkg.github.com/sgammon' > .npmrc && npm publish"
    label: ":octocat: + :npm: Staging: NPM"
    if: build.tag != null

  - command: "./gradlew build publish -Pgithub=true -Psigning=false"
    label: ":octocat: + :mvn: Staging: Maven"
    if: build.tag != null

  - command: "make release-images CI=yes REGISTRY=docker.pkg.github.com/sgammon/gust"
    label: ":octocat: + :whale: Staging: Docker"
    if: build.tag != null

  - input: "Request Release"
    if: build.tag != null
    fields:
      - select: "Stream"
        key: "release-stream"
        hint: "Which release stream does this belong in? :fork:"
        options:
          - label: "Beta"
            value: "beta"
          - label: "Stable"
            value: "stable"

  - command: "rm -f .npmrc && rm -f package.json && cp -fv package-global.json package.json && npm publish"
    label: ":npm: Release: NPM"
    if: build.tag != null

  - command: "make release-images CI=yes"
    label: ":docker: Release: Docker"
    if: build.tag != null
